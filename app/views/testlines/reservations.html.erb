<% isInit = true %>

<script type="text/javascript">
	var t = new Object();
	var pt =  Math.floor(new Date().getTime() / 1000);
</script>

<main class="wrapper" id="sidenav-container">
	<% reserve1 = firstReserve; %>
	<% if reserve1 == 0 %>
		<%= reservations_notice(@reservations, "reservations", notice) %>
	<% else %>
	    <aside class="sidenav">
	        <div class="wrapper">
	        	<ul>
		        	<% @testlines.each do |testline| %>
		        		<% if ( testline.reservations.count !=0) %>
		        			<li>
		        				<% if testline.id == reserve1 %>
									<a href="javascript:void(0)" class="sidenav-links active" onclick="openReservation(event, '<%= -testline.id %>')">
								<% else %>
									<a href="javascript:void(0)" class="sidenav-links" onclick="openReservation(event, '<%= -testline.id %>')">
								<% end %>
		                        		<i class="fa fa-server"></i> <%= testline.name %>
		                        	</a>
		                    </li>
				    	<% end %>     	
				    <% end %>
			    </ul>
			   
	        </div>
	    </aside>
	    <section id="reservations">
			<header>
				<button type="button" class="sidenav-toggler" onclick="toggleSideNav()">
					<i class="fa fa-caret-left show-left"></i> 
					<i class="fa fa-navicon"></i> 
					<i class="fa fa-caret-right show-right"></i>
				</button>
				<h2>Reservations</h2>
				<%= link_to reservations_download_log_file_path, :class => "download-link" do %>
					<i class="fa fa-download" aria-hidden="true"></i> Download log file
				<% end %>
			</header>
	        <% @testlines.each do |testline| %>
				<% if testline.id == reserve1 %>
					<ul id="<%= -testline.id %>" class="list-group" style="display: block; ">
				<% else %>
					<ul id="<%= -testline.id %>" class="list-group" style="display: none;">
				<% end %>
						<div class="vertical-bar"></div>
						<% currentReserve = 0 %>
						<% @reservations.each do |reserve| %>
							<% if testline.id == reserve.testline_id %>
					            <% if currentReserve == 0 %>
									<li class="list-item list-item-primary">
					                	<small class="badge badge-primary"><i class="fa fa-star"></i> Current</small>
					            <% elsif currentReserve == 1 %>
					            	<li class="list-item list-item-next">
					               		<small class="badge badge-next"><i class="fa fa-fast-forward"></i> Next in Line</small>
					            <% else %>
					            	<li class="list-item list-item-pending">
					               		<small class="badge badge-pending"><i class="fa fa-hourglass-1"></i> Pending</small>
					            <% end %>
						                <div class="list-item-header">
						                    <h3 class="title"><%= reserve.name %></h3>
						                    <small class="timestamp"><%= reserve.created_at.localtime.to_s(:db) %></small>
						                    <p class="subtitle"><%= reserve.team_name %> </p>
						                </div>
						                <p class="description"><%= reserve.description %>
						                </p>
						                <div class="list-item-footer">
						                    <small class="user">Reserved by <%= reserve.email %></small>
						                    <% if currentReserve == 0 %>
												<script>
													t[<%=--testline.id%>] = <%= (Time.now.minus_with_coercion(reserve.start_time)).to_i %>;
												</script>
												 <span class="time-used" id="<%= --testline.id %>"><i class="fa fa-clock-o"></i></span>
											<% end %>
						                </div>
						                <% if current_user.isAdmin? || (current_user.email == reserve.email )%>
						                	<!--<button type="button" class="release show-delete-modal"><i class="fa fa-times"></i> Release</button>-->
						                	<%= button_to [reserve.testline,reserve], method: :delete, :class => "release show-delete-modal", form: {:onsubmit => "return ask_modal(-#{reserve.id});"}, :id => "-#{reserve.id}" do %><i class="fa fa-times"></i> Release <% end %>
						               	<% end %>
						            </li>
						        <% currentReserve += 1 %>
				            <% end %>
				        
				    	<% end %>
			    </ul>
			<% end %>
	    </section>
	<% end %>
</main>

<div class="modal" id="remove_access">
    <div class="modal-confirm">
      <div class="modal-header">
        <button type="button" class="modal-close" onclick="cancel_modal()">&times;</button>
        <h3 class="modal-title"><i class="fa fa-trash"></i> Delete</h3>
      </div>
      <div class="modal-body">
        <p class="modal-text">Are you sure you want to delete this team?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn bg-red" onclick="confirm_modal()">Delete</button>
        <button type="button" class="modal-btn" onclick="cancel_modal()">Cancel</button>
      </div>
	  </div>
	</div>


<script>
	function activate_modal(id) {
		var s = document.getElementById(id);
	    s.style.display = "block";
	}

	function deactivate_modal(id) {
		var s = document.getElementById(id);
	    s.style.display = "none";
	}

	function openReservation(evt, cityName) {
	    var i, listgroups, sidenavlinks;

	    listgroups = document.getElementsByClassName("list-group");
	    for (i = 0; i < listgroups.length; i++) {
	        listgroups[i].style.display = "none";
	    }

	    // Get all elements with class="tablinks" and remove the class "active"
	    sidenavlinks = document.getElementsByClassName("sidenav-links");
	    for (i = 0; i < sidenavlinks.length; i++) {
	        sidenavlinks[i].className = sidenavlinks[i].className.replace(" active", "");
	    }

	    // Show the current tab, and add an "active" class to the link that opened the tab
	    document.getElementById(cityName).style.display = "block";
	    evt.currentTarget.className += " active";
	}
</script>

<script type="text/javascript">
	var delete_id = 0;

	function activate_modal(id) {
	document.getElementById(id).style.display = "block";
	}

	function deactivate_modal(id) {
	document.getElementById(id).style.display = "none";
	}

	function ask_modal(id) {
	if (id == delete_id)
		return true;
	document.getElementById("remove_access").style.display = "block";
	delete_id = id;
	return false;
	}

	function confirm_modal() {
	document.getElementById(delete_id).click();
	}

	function cancel_modal() {
	delete_id = 0;
	document.getElementById("remove_access").style.display = "none";
	}

</script>


<script type="text/javascript">
	var timers = Object.keys(t);

	startTime();
	function startTime() {
		for (let i = 0; i < timers.length; i++) {
		   	var myDate = secToTime(Math.floor((new Date().getTime()) / 1000) + t[timers[i]] - pt);
			document.getElementById(timers[i]).innerHTML = myDate;
		}

		setTimeout(startTime, 1000);
	}

	function secToTime(time) {
		var sec = time % 60;
		sec = (sec < 10) ? "0" + sec : sec.toString();
		var min = Math.floor(time/60) % 60;
		min = (min < 10) ? "0" + min : min.toString();
		var hr = Math.floor(time/3600);
		return hr + ":" + min + ":" + sec;
	}
</script>